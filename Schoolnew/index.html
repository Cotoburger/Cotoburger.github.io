<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="theme-color" id="themeColor" content="#87CEEB" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <link rel="shortcut icon" href="icons/icon-dark3x.png" />
    <link
      name="apple-touch-icon"
      href="icons/icon-dark1x.png"
      media="(prefers-color-scheme: dark)"
      sizes="128x128"
    />
    <link
      name="apple-touch-icon"
      href="icons/icon-dark2x.png"
      media="(prefers-color-scheme: dark)"
      sizes="256x256"
    />
    <link
      name="apple-touch-icon"
      href="icons/icon-dark3x.png"
      media="(prefers-color-scheme: dark)"
      sizes="384x384"
    />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover"
    />
    <meta property="og:title" content="Schedule" />
    <meta
      property="og:description"
      content="Расписание звонков в МАОУ Средняя школа №1"
    />
    <meta
      property="og:image"
      content="https://cotoburger.github.io/Schoolnew/icons/icon.svg"
    />
    <meta property="og:url" content="https://cotoburger.github.io/Schoolnew/" />
    <meta property="og:type" content="website" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Schedule" />
    <meta
      name="twitter:description"
      content="Расписание звонков в МАОУ Средняя школа №1 v2"
    />
    <meta
      name="twitter:image"
      content="https://cotoburger.github.io/Schoolnew/icons/icon.svg"
    />
    <meta
      name="twitter:url"
      content="https://cotoburger.github.io/Schoolnew/"
    />
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" href="icons/icon.svg" type="image/svg+xml" />
    
    <link rel="preload" href="foodmenu.txt" as="fetch" crossorigin>
    
    <link rel="stylesheet" href="styles.css">
    
    <title>Расписание уроков</title>
    
  </head>
  <body>
    <div class="day-header" id="dayOfWeek"></div>
    <div class="container">
      <div class="lesson-card">
        <div class="shift-number">1 смена</div>
        <div class="lesson-header">
          <div id="lesson1-name"></div>
          <div id="lesson1-remaining">
            <span class="hourglass-icon">
              <svg width="20" height="20" viewBox="0 0 21 21" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M19 3H5C4.44772 3 4 3.44772 4 4V6.58579C4 7.11622 4.21071 7.62493 4.58579 8L8 11.4142V12.5858L4.58579 16C4.21071 16.3751 4 16.8838 4 17.4142V20C4 20.5523 4.44772 21 5 21H19C19.5523 21 20 20.5523 20 20V17.4142C20 16.8838 19.7893 16.3751 19.4142 16L16 12.5858V11.4142L19.4142 8C19.7893 7.62493 20 7.11622 20 6.58579V4C20 3.44772 19.5523 3 19 3ZM18 6H6V5H18V6ZM12 11V13L15.4142 16.4142C15.7893 16.7893 16 17.298 16 17.8284V19H8V17.8284C8 17.298 8.21071 16.7893 8.58579 16.4142L12 13V11Z" fill="currentColor"/>
              </svg>
            </span>
            <span class="remaining-text"></span>
          </div>
        </div>
        <div class="progress-time-labels">
          <span id="lesson1-start-time"></span>
          <span id="lesson1-end-time"></span>
        </div>
        <div class="progress-bar">
          <div id="lesson1-progress"></div>
        </div>
      </div>
      <div class="lesson-card">
        <div class="shift-number">2 смена</div>
        <div class="lesson-header">
          <div id="lesson2-name"></div>
          <div id="lesson2-remaining">
            <span class="hourglass-icon">
              <svg width="20" height="20" viewBox="0 0 21 21" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M19 3H5C4.44772 3 4 3.44772 4 4V6.58579C4 7.11622 4.21071 7.62493 4.58579 8L8 11.4142V12.5858L4.58579 16C4.21071 16.3751 4 16.8838 4 17.4142V20C4 20.5523 4.44772 21 5 21H19C19.5523 21 20 20.5523 20 20V17.4142C20 16.8838 19.7893 16.3751 19.4142 16L16 12.5858V11.4142L19.4142 8C19.7893 7.62493 20 7.11622 20 6.58579V4C20 3.44772 19.5523 3 19 3ZM18 6H6V5H18V6ZM12 11V13L15.4142 16.4142C15.7893 16.7893 16 17.298 16 17.8284V19H8V17.8284C8 17.298 8.21071 16.7893 8.58579 16.4142L12 13V11Z" fill="currentColor"/>
              </svg>
            </span>
            <span class="remaining-text"></span>
          </div>
        </div>
        <div class="progress-time-labels">
          <span id="lesson2-start-time"></span>
          <span id="lesson2-end-time"></span>
        </div>
        <div class="progress-bar">
          <div id="lesson2-progress"></div>
        </div>
      </div>
      <div class="lesson-card">
        <div id="meal-table-container"></div>
      </div>
    </div>
    <div class="container">
      <div class="lesson-card-full">
        <button class="open-full-schedule">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="1" y="1" rx="7" width="18" height="18" stroke="currentColor" stroke-width="2"/>
            <path d="M13.14 7.55L6.08 15.49C5.77 15.84 5.24 15.87 4.88 15.56C4.53 15.24 4.5 14.71 4.81 14.36L11.87 6.42L7.13 6.7C6.66 6.73 6.26 6.37 6.23 5.9C6.21 5.42 6.56 5.03 7.03 5L13.82 4.6C14.3 4.57 14.69 4.92 14.72 5.4L15.12 12.19C15.15 12.66 14.8 13.06 14.32 13.09C13.84 13.11 13.45 12.76 13.42 12.29L13.14 7.55Z" fill="currentColor"/>
          </svg>
        </button>
        <div class="schedule-header">Расписание</div>
        <div class="full-schedule-container">
          <div class="shift-schedule">
            <div class="schedule-index">1 смена</div>
            <div id="shift1-full"></div>
          </div>
          <div class="shift-schedule">
            <div class="schedule-index">2 смена</div>
            <div id="shift2-full"></div>
          </div>
          <div class="shift-schedule">
            <div class="schedule-index">Питание</div>
            <div id="meals-full"></div>
          </div>
        </div>
      </div>
    </div>
    <p id="last-deployment">Getting data...</p>
    <div class="full-schedule-panel" style="display: none">
      <div class="panel-content">
        <button class="close-panel">
          <svg width="25" height="25" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="1" y="1" rx="7" width="18" height="18" stroke="currentColor" stroke-width="2"/>
            <line x1="5" y1="15" x2="15" y2="5" stroke="currentColor" stroke-width="2"/>
            <path d="M15 15L5 5" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
        </button>
        <div class="day-navigation">
          <button id="prevDay"><</button>
          <h2 id="currentDayTitle">Расписание</h2>
          <button id="nextDay">></button>
        </div>
        <div class="schedule-slider" id="scheduleSlider"></div>
      </div>
    </div>
    <script>
      (function () {
        function updateVh() {
          const vh = window.innerHeight * 0.01;
          document.documentElement.style.setProperty("--vh", vh + "px");
        }
        function resetScroll() {
          window.scrollTo(0, 0);
          document.documentElement.scrollTop = 0;
          document.body.scrollTop = 0;
        }
        let userScrolled = false;
        window.addEventListener("scroll", () => { userScrolled = true; }, { once: true, passive: true });
        if ("scrollRestoration" in history) {
          try { history.scrollRestoration = "manual"; } catch (e) {}
        }
        window.addEventListener("load", () => {
          updateVh();
          if (!userScrolled) {
            resetScroll();
            setTimeout(() => { if (!userScrolled) resetScroll(); }, 100);
          }
        });
        window.addEventListener("resize", updateVh, { passive: true });
        window.addEventListener("orientationchange", () => {
            updateVh();
            if (!userScrolled) resetScroll();
          }, { passive: true });
      })();
    </script>
    <script>
      const lessons1 = 0;
      const lessons2 = 0;
      const reasons = {
        0: null,
        1: "Занятия отменены из за плохой погоды",
        2: "Уроков нет по техническим причинам",
        3: "Уроков нет — каникулы ☺",
        4: "Кимпинтяо",
        5: "Чупапимуняню",
        6: "Уроков нет — день самоуправления",
        7: "/Schoolnew/icons/icon-dark1x.png",
      };
      const schedule = {
        1: {
          shift1: [
            { lesson: "Классный час", start: "08:15", end: "08:45" },
            { lesson: "1-й урок", start: "08:55", end: "09:35" },
            { lesson: "2-й урок", start: "09:50", end: "10:30" },
            { lesson: "3-й урок", start: "10:45", end: "11:25" },
            { lesson: "4-й урок", start: "11:30", end: "12:10" },
            { lesson: "5-й урок", start: "12:20", end: "13:00" },
            { lesson: "6-й урок", start: "13:20", end: "14:00" },
            { lesson: "7-й урок", start: "14:15", end: "14:55" },
          ],
          shift2: [
            { lesson: "0-й урок", start: "12:20", end: "13:00" },
            { lesson: "1-й урок", start: "13:20", end: "14:00" },
            { lesson: "2-й урок", start: "14:15", end: "14:55" },
            { lesson: "3-й урок", start: "15:10", end: "15:50" },
            { lesson: "Классный час", start: "16:05", end: "16:35" },
            { lesson: "4-й урок", start: "16:40", end: "17:20" },
            { lesson: "5-й урок", start: "17:30", end: "18:10" },
            { lesson: "6-й урок", start: "18:20", end: "19:00" },
          ],
        },
        2: {
          shift1: [
            { lesson: "1-й урок", start: "08:15", end: "08:55" },
            { lesson: "2-й урок", start: "09:05", end: "09:45" },
            { lesson: "3-й урок", start: "10:00", end: "10:40" },
            { lesson: "4-й урок", start: "11:00", end: "11:40" },
            { lesson: "5-й урок", start: "11:50", end: "12:30" },
            { lesson: "6-й урок", start: "12:50", end: "13:30" },
            { lesson: "7-й урок", start: "13:50", end: "14:30" },
          ],
          shift2: [
            { lesson: "0-й урок", start: "11:50", end: "12:30" },
            { lesson: "1-й урок", start: "12:50", end: "13:30" },
            { lesson: "2-й урок", start: "13:50", end: "14:30" },
            { lesson: "3-й урок", start: "14:45", end: "15:25" },
            { lesson: "4-й урок", start: "15:40", end: "16:20" },
            { lesson: "5-й урок", start: "16:30", end: "17:10" },
            { lesson: "6-й урок", start: "17:20", end: "18:00" },
          ],
        },
        3: {
          shift1: [
            { lesson: "1-й урок", start: "08:15", end: "08:55" },
            { lesson: "2-й урок", start: "09:05", end: "09:45" },
            { lesson: "3-й урок", start: "10:00", end: "10:40" },
            { lesson: "Классный час", start: "10:55", end: "11:25" },
            { lesson: "4-й урок", start: "11:30", end: "12:10" },
            { lesson: "5-й урок", start: "12:20", end: "13:00" },
            { lesson: "6-й урок", start: "13:20", end: "14:00" },
            { lesson: "7-й урок", start: "14:15", end: "14:55" },
          ],
          shift2: [
            { lesson: "0-й урок", start: "12:20", end: "13:00" },
            { lesson: "1-й урок", start: "13:20", end: "14:00" },
            { lesson: "2-й урок", start: "14:15", end: "14:55" },
            { lesson: "3-й урок", start: "15:10", end: "15:50" },
            { lesson: "Классный час", start: "16:05", end: "16:35" },
            { lesson: "4-й урок", start: "16:40", end: "17:20" },
            { lesson: "5-й урок", start: "17:30", end: "18:10" },
            { lesson: "6-й урок", start: "18:20", end: "19:00" },
          ],
        },
        4: {
          shift1: [
            { lesson: "1-й урок", start: "08:15", end: "08:55" },
            { lesson: "2-й урок", start: "09:05", end: "09:45" },
            { lesson: "3-й урок", start: "10:00", end: "10:40" },
            { lesson: "Классный час", start: "10:55", end: "11:25" },
            { lesson: "4-й урок", start: "11:30", end: "12:10" },
            { lesson: "5-й урок", start: "12:20", end: "13:00" },
            { lesson: "6-й урок", start: "13:20", end: "14:00" },
            { lesson: "7-й урок", start: "14:15", end: "14:55" },
          ],
          shift2: [
            { lesson: "0-й урок", start: "12:20", end: "13:00" },
            { lesson: "1-й урок", start: "13:20", end: "14:00" },
            { lesson: "2-й урок", start: "14:15", end: "14:55" },
            { lesson: "3-й урок", start: "15:10", end: "15:50" },
            { lesson: "Классный час", start: "16:05", end: "16:35" },
            { lesson: "4-й урок", start: "16:40", end: "17:20" },
            { lesson: "5-й урок", start: "17:30", end: "18:10" },
            { lesson: "6-й урок", start: "18:20", end: "19:00" },
          ],
        },
        5: {
          shift1: [
            { lesson: "1-й урок", start: "08:15", end: "08:55" },
            { lesson: "2-й урок", start: "09:05", end: "09:45" },
            { lesson: "3-й урок", start: "10:00", end: "10:40" },
            { lesson: "4-й урок", start: "11:00", end: "11:40" },
            { lesson: "5-й урок", start: "11:50", end: "12:30" },
            { lesson: "6-й урок", start: "12:50", end: "13:30" },
            { lesson: "7-й урок", start: "13:50", end: "14:30" },
          ],
          shift2: [
            { lesson: "0-й урок", start: "11:50", end: "12:30" },
            { lesson: "1-й урок", start: "12:50", end: "13:30" },
            { lesson: "2-й урок", start: "13:50", end: "14:30" },
            { lesson: "3-й урок", start: "14:45", end: "15:25" },
            { lesson: "4-й урок", start: "15:40", end: "16:20" },
            { lesson: "5-й урок", start: "16:30", end: "17:10" },
            { lesson: "6-й урок", start: "17:20", end: "18:00" },
          ],
        },
        6: { shift1: [], shift2: [] },
        0: { shift1: [], shift2: [] },
      };

      let lastUpdateTime = 0;
      const UPDATE_INTERVAL = 3600000;

      async function copyMealMenu(btn) {
        const container = document.getElementById("meal-table-container");
        if (!container) return;
        
        const rows = container.querySelectorAll('.meal-row');
        const dateHeader = container.querySelector('.meal-header-text')?.textContent || "Меню";
        let textToCopy = `${dateHeader}:\n`;
        
        rows.forEach(row => {
          const title = row.querySelector('.meal-title')?.textContent || "";
          const items = row.querySelector('.meal-items')?.textContent || "";
          if (title && items) textToCopy += `\n${title}: ${items}\n`;
        });

        try {
          await navigator.clipboard.writeText(textToCopy.trim());
          const originalIcon = btn.innerHTML;
          btn.innerHTML = '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#4ade80" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
          setTimeout(() => { btn.innerHTML = originalIcon; }, 2000);
        } catch (err) {
          console.error('Ошибка копирования:', err);
        }
      }

      function updateMealDisplay() {
        async function loadFoodMenu() {
          try {
            const resp = await fetch("./foodmenu.txt", { cache: "no-store" });
            const text = await resp.text();
            const lines = text.split("\n").map(l => l.trim()).filter(l => l);
            const food = {};
            lines.forEach(line => {
              const [meal, items] = line.split(":");
              food[meal] = items.split(",").map(i => i.trim());
            });
            return food;
          } catch (e) {
            console.error("Не удалось загрузить foodmenu.txt", e);
            return null;
          }
        }

        async function renderMealTable() {
          const tableContainer = document.getElementById("meal-table-container");
          if (!tableContainer) return;
          const currentTime = Date.now();
          if (currentTime - lastUpdateTime < UPDATE_INTERVAL) return;
          
          renderPlaceholderTable(tableContainer);
          lastUpdateTime = currentTime;
          let food = await loadFoodMenu();
          if (food === null) food = {};
          
          const menuDate = food["Дата меню"] || null;
          if (menuDate) delete food["Дата меню"];
          let dateLabel = menuDate ? ` (${menuDate})` : "";
          
          let tableHtml = `
            <div class="meal-table" style="width:100%; font-size:1.1em; background:rgba(255,255,255,0.13); border-radius:0.7em; overflow:hidden;">
              <div style="display: flex; align-items: center; justify-content: center; position: relative; padding: 0.4em 0.2em; background:rgba(0,0,0,0.07); border-radius: 0.5em; margin: 0.5em;">
                <div class="meal-header-text" style="font-weight: 600;">Меню${dateLabel}</div>
                <button onclick="copyMealMenu(this)" style="position: absolute; right: 8px; background: none; border: none; color: inherit; cursor: pointer; display: flex; align-items: center; padding: 4px; opacity: 0.7;">
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                </button>
              </div>
          `;
          
          const order = ["Завтрак", "Обед", "Полдник"];
          order.forEach(meal => {
            const addBorder = meal !== "Полдник";
            const menuItems = food[meal] ? food[meal].join(", ") : "";
            tableHtml += `
              <div class="meal-row" style="margin-bottom: 0.5em; padding: 0.6em 0.3em; ${addBorder ? 'border-bottom:1px solid rgba(255,255,255,0.1);' : ''}">
                <div class="meal-title" style="font-weight: 600; margin-bottom: 0.2em;">${meal}</div>
                <div class="meal-items">${menuItems}</div>
              </div>
            `;
          });
          tableHtml += `</div>`;
          
          tableContainer.style.transition = 'height 0.3s ease-in-out';
          tableContainer.style.overflow = 'hidden';
          const currentHeight = tableContainer.offsetHeight;
          tableContainer.style.height = `${currentHeight}px`;
          tableContainer.offsetHeight;
          tableContainer.innerHTML = tableHtml;
          const newHeight = tableContainer.scrollHeight;
          tableContainer.style.height = `${newHeight}px`;
          setTimeout(() => {
            tableContainer.style.height = '';
            tableContainer.style.overflow = '';
            tableContainer.style.transition = '';
          }, 300);
        }

        function renderPlaceholderTable(container) {
          container.innerHTML = `
            <div class="meal-table" style="width:100%; font-size:1.1em; background:rgba(255,255,255,0.13); border-radius:0.7em; overflow:hidden;">
              <div style="text-align: center; font-weight: 600; padding: 0.4em 0.4em; background:rgba(0,0,0,0.07); border-radius: 0.5em; margin: 0.5em;">Меню(xx.xx.xxxx)</div>
            </div>`;
        }
        renderMealTable();
      }

      try {
        if (!(lessons1 !== 0 && lessons2 !== 0)) updateMealDisplay();
      } catch (e) { console.warn("Meal update failed", e); }

      function applyNoLessonsReasonToShifts() {
        const shift1Card = document.querySelector(".lesson-card:nth-child(1)");
        const shift2Card = document.querySelector(".lesson-card:nth-child(2)");
        function getReasonContent(reasonId) {
          const reason = reasons[reasonId];
          if (!reason) return "";
          if (typeof reason === "string" && reason.trim().startsWith("<")) return reason;
          if (typeof reason === "string" && (reason.startsWith("http") || reason.startsWith("/") || reason.startsWith("./"))) {
            return `<img src="${reason}" alt="Причина отмены" class="no-lessons-image">`;
          }
          return `<div class="no-lessons-message-text">${reason}</div>`;
        }
        if (lessons1 !== 0 && shift1Card) {
          shift1Card.innerHTML = `<div class="no-lessons-header">1 смена</div><div class="no-lessons-content">${getReasonContent(lessons1)}</div>`;
          shift1Card.classList.remove("collapsed");
          shift1Card.classList.add("no-lessons");
        } else if (shift1Card) shift1Card.classList.remove("no-lessons");
        if (lessons2 !== 0 && shift2Card) {
          shift2Card.innerHTML = `<div class="no-lessons-header">2 смена</div><div class="no-lessons-content">${getReasonContent(lessons2)}</div>`;
          shift2Card.classList.remove("collapsed");
          shift2Card.classList.add("no-lessons");
        } else if (shift2Card) shift2Card.classList.remove("no-lessons");
        if (lessons1 !== 0 || lessons2 !== 0) document.body.classList.add("no-lessons");
        else document.body.classList.remove("no-lessons");
        const mealCard = document.querySelectorAll(".lesson-card")[2];
        if (mealCard) {
          if (lessons1 !== 0 && lessons2 !== 0) mealCard.style.display = "none";
          else {
            mealCard.style.display = "";
            if (!mealCard.querySelector("#meal-table-container")) {
              mealCard.innerHTML = `<div id="meal-table-container""></div>`;
            }
            mealCard.classList.remove("no-lessons");
          }
        }
      }

      function getCurrentTimeInKamchatkaContext() {
        const now = new Date();
        return `${now.getHours()}:${String(now.getMinutes()).padStart(2, "0")}:${String(now.getSeconds()).padStart(2, "0")}`;
      }
      function getCurrentDayOfWeek() {
        const now = new Date();
        const kamchatkaDate = new Date(now.getTime() + (12 * 60 + now.getTimezoneOffset()) * 60 * 1000);
        const day = kamchatkaDate.getDay();
        return day === 0 ? 0 : day;
      }
      function timeToSeconds(t) {
        const p = t.split(":").map(Number);
        return p[0] * 3600 + p[1] * 60 + (p[2] || 0);
      }
      function isTimeBetween(curr, start, end) {
        const now = new Date();
        const offset = (12 * 60 + now.getTimezoneOffset()) * 60;
        let currSec = (timeToSeconds(curr) + offset) % 86400;
        if (currSec < 0) currSec += 86400;
        const sSec = timeToSeconds(start);
        let eSec = timeToSeconds(end);
        if (eSec < sSec) eSec += 86400;
        return currSec >= sSec && currSec < eSec;
      }

      function renderFullSchedule() {
        const day = getCurrentDayOfWeek();
        const currentTime = getCurrentTimeInKamchatkaContext();
        const scheduleData = schedule[day];
        function renderShift(shiftKey, containerId) {
          const container = document.getElementById(containerId);
          if (!container || !scheduleData || !scheduleData[shiftKey]) {
            if (container) container.innerHTML = "";
            return;
          }
          container.innerHTML = "";
          scheduleData[shiftKey].forEach((lesson) => {
            const isClassHour = lesson.lesson.toLowerCase().includes("классный час");
            const lessonNumberMatch = lesson.lesson.match(/^(\d+)-й урок/);
            let lessonNumber = isClassHour ? "КЛ" : (lessonNumberMatch ? lessonNumberMatch[1] : "");
            const isCurrent = isTimeBetween(currentTime, lesson.start, lesson.end);
            const lessonEl = document.createElement("div");
            lessonEl.className = `lesson-item ${isCurrent ? "current" : ""}`;
            lessonEl.innerHTML = `<div class="lesson-number">${lessonNumber}</div><div class="lesson-time">${lesson.start} - ${lesson.end}</div>`;
            container.appendChild(lessonEl);
          });
        }
        renderShift("shift1", "shift1-full");
        renderShift("shift2", "shift2-full");
        try {
          const mealsContainer = document.getElementById("meals-full");
          if (mealsContainer) {
            const parent = mealsContainer.closest('.shift-schedule');
            if (parent) parent.style.display = 'none';
          }
        } catch (e) {}
      }

      function calculateRemainingTime(curr, end) {
        const now = new Date();
        const offset = (12 * 60 + now.getTimezoneOffset()) * 60;
        let currSec = (timeToSeconds(curr) + offset) % 86400;
        if (currSec < 0) currSec += 86400;
        let eSec = timeToSeconds(end + ":00");
        if (eSec < currSec) eSec += 86400;
        const rem = eSec - currSec;
        if (rem >= 3600) return `${Math.floor(rem / 3600)} ч ${Math.ceil((rem % 3600) / 60)} мин`;
        return rem >= 60 ? `${Math.ceil(rem / 60)} мин` : `${Math.ceil(rem)} сек`;
      }

      function formatTimeDifference(diff) {
        if (diff <= 0) return "0 мин";
        const d = Math.floor(diff / 86400);
        diff %= 86400;
        const h = Math.floor(diff / 3600);
        const m = Math.floor((diff % 3600) / 60);
        const p = [];
        if (d > 0) p.push(`${d} дн`);
        if (h > 0) p.push(`${h} ч`);
        if (m > 0 || p.length === 0) p.push(`${m} мин`);
        return p.join(" ");
      }

      function updateProgressBar(bar, curr, start, end) {
        const now = new Date();
        const offset = (12 * 60 + now.getTimezoneOffset()) * 60;
        let currSec = (timeToSeconds(curr) + offset) % 86400;
        if (currSec < 0) currSec += 86400;
        const sSec = timeToSeconds(start);
        let eSec = timeToSeconds(end);
        if (eSec < sSec) eSec += 86400;
        const total = eSec - sSec;
        const elapsed = currSec - sSec;
        bar.style.width = (total > 0 && elapsed >= 0) ? `${Math.min(100, (elapsed / total) * 100)}%` : "0%";
      }

      function findNextLessonTime(shiftData, curr, day, shiftKey) {
        const now = new Date();
        const offset = (12 * 60 + now.getTimezoneOffset()) * 60;
        let currSec = (timeToSeconds(curr) + offset) % 86400;
        if (currSec < 0) currSec += 86400;
        let next = shiftData.find(l => timeToSeconds(l.start) > currSec);
        let nextDay = day;
        if (!next && day < 5) {
          const nDay = schedule[day + 1];
          if (nDay?.[shiftKey]?.[0]) { next = nDay[shiftKey][0]; nextDay = day + 1; }
        }
        if (next) {
          const [h, m] = next.start.split(":").map(Number);
          let nDate = new Date();
          nDate.setDate(nDate.getDate() + (nextDay - day));
          nDate.setHours(h, m, 0, 0);
          nDate = new Date(nDate.getTime() - offset * 1000);
          let d = Math.floor((nDate - now) / 1000);
          if (d < 0) d += 86400;
          return formatTimeDifference(d);
        }
        return null;
      }

      function updateShiftDisplay(data, nameEl, remEl, startEl, endEl, bar, key) {
        const lessonCard = nameEl.closest(".lesson-card");
        lessonCard.classList.remove("collapsed");
        bar.parentElement.classList.remove("hidden");
        startEl.parentElement.classList.remove("hidden");
        if (!data || data.length === 0) {
          nameEl.textContent = "Нет уроков";
          remEl.style.visibility = "hidden";
          bar.parentElement.classList.add("hidden");
          startEl.parentElement.classList.add("hidden");
          lessonCard.classList.add("collapsed");
          return;
        }
        const curr = getCurrentTimeInKamchatkaContext();
        const idx = data.findIndex(l => isTimeBetween(curr, l.start, l.end));
        if (idx !== -1) {
          const l = data[idx];
          nameEl.textContent = l.lesson;
          remEl.style.visibility = "visible";
          remEl.querySelector(".remaining-text").textContent = calculateRemainingTime(curr, l.end);
          const { startDate, endDate } = getLocalTimes(l.start, l.end);
          startEl.textContent = `${String(startDate.getHours()).padStart(2, "0")}:${String(startDate.getMinutes()).padStart(2, "0")}`;
          endEl.textContent = `${String(endDate.getHours()).padStart(2, "0")}:${String(endDate.getMinutes()).padStart(2, "0")}`;
          updateProgressBar(bar, curr, `${l.start}:00`, `${l.end}:00`);
        } else {
          let isBreak = false, next = null, bStart = null;
          for (let i = 0; i < data.length - 1; i++) {
            const e = timeToSeconds(data[i].end), s = timeToSeconds(data[i+1].start), n = (timeToSeconds(curr) + (12 * 60 + new Date().getTimezoneOffset()) * 60) % 86400;
            if (n > e && n < s) { isBreak = true; next = data[i+1]; bStart = data[i].end; break; }
          }
          if (isBreak && next) {
            nameEl.textContent = "Перемена";
            remEl.style.visibility = "visible";
            remEl.querySelector(".remaining-text").textContent = calculateRemainingTime(curr, next.start);
            const { startDate, endDate } = getLocalTimes(bStart, next.start);
            startEl.textContent = `${String(startDate.getHours()).padStart(2, "0")}:${String(startDate.getMinutes()).padStart(2, "0")}`;
            endEl.textContent = `${String(endDate.getHours()).padStart(2, "0")}:${String(endDate.getMinutes()).padStart(2, "0")}`;
            updateProgressBar(bar, curr, `${bStart}:00`, `${next.start}:00`);
          } else {
            const tNext = findNextLessonTime(data, curr, getCurrentDayOfWeek(), key);
            nameEl.textContent = tNext ? `До урока: ${tNext}` : "Уроки кончились";
            remEl.style.visibility = "hidden";
            bar.parentElement.classList.add("hidden");
            startEl.parentElement.classList.add("hidden");
            lessonCard.classList.add("collapsed");
          }
        }
      }

      function getLocalTimes(s, e) {
        const now = new Date(), [sh, sm] = s.split(":").map(Number), [eh, em] = e.split(":").map(Number);
        const sd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), sh, sm), ed = new Date(now.getFullYear(), now.getMonth(), now.getDate(), eh, em);
        const off = 12 * 60 + now.getTimezoneOffset();
        sd.setMinutes(sd.getMinutes() - off); ed.setMinutes(ed.getMinutes() - off);
        return { startDate: sd, endDate: ed };
      }

      function updateThemeAndBackground() {
        const now = new Date(), off = 12 * 60 + now.getTimezoneOffset(), kDate = new Date(now.getTime() + off * 60 * 1000), hour = kDate.getHours();
        const names = ["Воскресенье", "Понедельник", "Вторник", "Среда", "Четверг", "Пятница", "Суббота"];
        document.getElementById("dayOfWeek").textContent = names[getCurrentDayOfWeek()];
        let bg, color, isNight = hour < 6 || hour >= 20;
        if (isNight) { bg = "#000000"; color = "#000000"; removeClouds(); if (!document.querySelector(".star")) createStars(); document.body.classList.add("night-mode"); }
        else {
          if (hour < 12) bg = color = "#927A46"; else if (hour < 17) bg = color = "#5D827F"; else if (hour < 18) bg = color = "#6B7C8E"; else bg = color = "#4B5B6E";
          removeStars(); if (!document.querySelector(".cloud")) createClouds(); document.body.classList.remove("night-mode");
        }
        document.documentElement.style.backgroundColor = bg;
        const meta = document.getElementById("themeColor"); if (meta) meta.setAttribute("content", color);
        setTimeout(() => { document.documentElement.style.transition = "background-color 0.5s ease"; }, 50);
      }

      function updateSchedule() {
        updateThemeAndBackground();
        applyNoLessonsReasonToShifts();
        const day = getCurrentDayOfWeek(), today = schedule[day];
        const shifts = [
          { name: "lesson1", data: today?.shift1, key: "shift1", cancel: lessons1 },
          { name: "lesson2", data: today?.shift2, key: "shift2", cancel: lessons2 },
        ];
        shifts.forEach((s) => {
          const nameEl = document.getElementById(`${s.name}-name`);
          if (s.cancel === 0 && nameEl) updateShiftDisplay(s.data, nameEl, document.getElementById(`${s.name}-remaining`), document.getElementById(`${s.name}-start-time`), document.getElementById(`${s.name}-end-time`), document.getElementById(`${s.name}-progress`), s.key);
        });
        try { if (!(lessons1 !== 0 && lessons2 !== 0)) updateMealDisplay(); } catch (e) {}
        renderFullSchedule();
      }

      function createStars() {
        removeStars();
        const container = document.createElement("div");
        container.style.position = "fixed";
        container.style.top = "0";
        container.style.left = "0";
        container.style.width = "100vw";
        container.style.height = "100vh";
        container.style.pointerEvents = "none";
        container.style.zIndex = "1";
        const numStars = 45;
        for (let i = 0; i < numStars; i++) {
          const star = document.createElement("div");
          star.classList.add("star");
          star.style.left = `${Math.random() * 100}vw`;
          star.style.top = `${Math.random() * 100}vh`;
          const size = Math.random() * 3.0 + 1;
          star.style.width = `${size}px`;
          star.style.height = `${size}px`;
          star.style.animationDuration = `${Math.random() * 2 + 1}s`;
          star.style.animationDelay = `${Math.random() * 2}s`;
          container.appendChild(star);
        }
        document.body.appendChild(container);
      }

      function createClouds() {
        if (document.getElementById("cloud-container")) return;
        const isWinter = [12, 1, 2].includes(new Date().getMonth() + 1), c = document.createElement("div");
        c.id = "cloud-container"; Object.assign(c.style, { position: "fixed", top: "0", left: "0", width: "100vw", height: "100vh", pointerEvents: "none", zIndex: "1", overflow: "hidden" });
        const sw = window.innerWidth;
        if (!isWinter) {
          const num = Math.max(6, Math.min(20, Math.round(((sw - 400) / 1600) * 14 + 6)));
          for (let i = 0; i < num; i++) {
            const cl = document.createElement("div"); cl.classList.add("cloud");
            cl.style.top = `${Math.random() * 10 + 4}vh`; cl.dataset.baseWidth = Math.random() * 50 + 60;
            cl.style.left = `${Math.random() * 100}vw`; cl.style.animationDelay = `${-(Math.random() * 100)}s`;
            c.appendChild(cl);
          }
        } else {
          for (let i = 0; i < Math.floor(sw / 25); i++) {
            const f = document.createElement("div"); f.classList.add("snowflake");
            Object.assign(f.style, { left: `${Math.random() * 100}vw`, animationDelay: `${Math.random() * -20}s`, animationDuration: `${Math.random() * 10 + 10}s` });
            c.appendChild(f);
          }
        }
        document.body.appendChild(c);
        if (!isWinter) updateClouds();
      }

      function updateClouds() {
        const sw = window.innerWidth;
        document.querySelectorAll(".cloud").forEach(cl => {
          const w = parseFloat(cl.dataset.baseWidth) * Math.min(2.8, Math.max(1, sw / 2000 + 0.5));
          Object.assign(cl.style, { width: `${w}px`, height: `${w * 0.85}px`, animationDuration: `${Math.max(20, Math.min(300, ((sw - 400) / 1600) * 280 + 20))}s` });
        });
      }

      function removeClouds() { const c = document.getElementById("cloud-container"); if (c) c.remove(); }
      function removeStars() { document.querySelectorAll('div[style*="position: fixed"] .star').forEach(s => s.closest("div").remove()); }

      function renderWeeklySchedule() {
        const slider = document.getElementById("scheduleSlider"); if (!slider) return;
        slider.innerHTML = "";
        for (let d = 1; d <= 5; d++) {
          const dayEl = document.createElement("div"); dayEl.className = "day-schedule";
          ["shift1", "shift2"].forEach(k => {
            const sEl = document.createElement("div"); sEl.className = "shift-schedule";
            sEl.innerHTML = `<div class="schedule-index">${k === "shift1" ? "1 смена" : "2 смена"}</div>`;
            schedule[d][k].forEach(l => {
              const lEl = document.createElement("div"); lEl.className = "lesson-item";
              lEl.innerHTML = `<div class="lesson-time">${l.start} - ${l.end}</div><div class="full-lesson-name">${l.lesson}</div>`;
              sEl.appendChild(lEl);
            });
            dayEl.appendChild(sEl);
          });
          slider.appendChild(dayEl);
        }
      }

      function openSchedulePanel() {
        renderWeeklySchedule(); updateDayDisplay();
        const p = document.querySelector(".full-schedule-panel");
        if (p) { p.style.display = "block"; document.body.style.overflow = "hidden"; setTimeout(() => p.classList.add("open"), 10); }
      }
      function closeSchedulePanel() {
        const p = document.querySelector(".full-schedule-panel");
        if (p) { p.classList.remove("open"); p.classList.add("closing"); document.body.style.overflow = ""; setTimeout(() => { p.style.display = "none"; p.classList.remove("closing"); }, 300); }
      }

      let currentDayIndex = getCurrentDayOfWeek(); if (currentDayIndex === 0 || currentDayIndex === 6) currentDayIndex = 1;
      function updateDayDisplay() {
        const names = ["Воскресенье", "Понедельник", "Вторник", "Среда", "Четверг", "Пятница", "Суббота"];
        const t = document.getElementById("currentDayTitle"), s = document.getElementById("scheduleSlider");
        if (t) t.textContent = names[currentDayIndex];
        if (s) Array.from(s.children).forEach(c => c.style.transform = `translateX(-${(currentDayIndex - 1) * 100}%)`);
      }

      window.addEventListener("resize", updateClouds);
      document.getElementById("prevDay")?.addEventListener("click", () => { if (currentDayIndex > 1) { currentDayIndex--; updateDayDisplay(); } });
      document.getElementById("nextDay")?.addEventListener("click", () => { if (currentDayIndex < 5) { currentDayIndex++; updateDayDisplay(); } });
      document.querySelector(".open-full-schedule")?.addEventListener("click", openSchedulePanel);
      document.querySelector(".close-panel")?.addEventListener("click", closeSchedulePanel);

      setInterval(updateSchedule, 1000);
      updateSchedule();

      function updateDeployment() {
        const el = document.getElementById("last-deployment");
        fetch("https://api.github.com/repos/Cotoburger/Cotoburger.github.io/deployments", { headers: { Accept: "application/vnd.github.v3+json" } })
          .then(r => r.json()).then(data => {
            if (data.length === 0) return;
            const d = new Date(data[0].created_at);
            fetch(data[0].statuses_url, { headers: { Accept: "application/vnd.github.v3+json" } })
              .then(sr => sr.json()).then(st => {
                const s = st[0]?.state === "success" ? "OK" : (st[0]?.state === "failure" ? "ERR" : "Work");
                if (el) el.innerHTML = `Меню взято с сайта школы <br> Изменение кода: ${d.toLocaleDateString("ru-RU")} ${d.toLocaleTimeString("ru-RU")} (${s})`;
              });
          }).catch(() => { if (el) el.textContent = ""; });
      }

      const obs = new IntersectionObserver((es, o) => { es.forEach(e => { if (e.isIntersecting) { updateDeployment(); setInterval(updateDeployment, 90000); o.unobserve(e.target); } }); });
      if (target = document.getElementById("last-deployment")) obs.observe(target);
    </script>
  </body>
</html>